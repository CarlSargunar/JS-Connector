<!DOCTYPE html>
<html>
<head>
  <title>Loop54</title>
  <link href="nouislider.min.css" rel="stylesheet" />
  <style>
    #searchResult {
      font-size: 9px;
      font-family: monospace;
      max-width: 100%;
    }

    .range-slider {
      max-width: 50%;
      margin-left: 20px;
      margin-right: 20px;
    }
  </style>
</head>
<body>
  <h1>Loop54-js-lib Testing environment</h1>
  <hr />
  <a href="#search">Search</a> | 
  <a href="#autocomplete">AutoComplete</a> | 
  <a href="#getentities">GetEntities</a> | 
  <a href="#getentitiesbyattribute">GetEntitiesByAttribute</a> | 
  <a href="#getrelatedentities">GetRelatedEntities</a>

  <form id="form" onsubmit="return callLoop54()">
    <p>
      Query: <input type="text" name="query" value="meat" />
    </p>
	<h2>Options</h2>
	<p>
      Skip: <input type="text" name="skip" value="0" />
    </p>
	<p>
      Take: <input type="text" name="take" value="10" />
    </p>
	<div id="inputFacets">
		<h2>Define facets</h2>
		<p>
		  Distinct: <input type="text" name="distinctFacets" value="Manufacturer,Category" />
		</p>
		<p>
		  Range: <input type="text" name="rangeFacets" value="OrgPrice" />
		</p>
	</div>
	<p>
	  <input type="submit" value="Post" />
	</p>
  </form>
  
  <hr />
  
  <div id="outputFacets">
	  <h2>Facets</h2>
	  <form id="facetsForm" onchange="return updateFacets()">
	  
	  </form>
	  
	  <hr />
  </div>

  <h2>Results (Count: <span id="resultCount"></span>)</h2>
  <pre id="searchResult"></pre>
  <script src="nouislider.min.js"></script>
  <script src="loop54-js-lib.js"></script>
  <script type="text/javascript">
    console.log(Loop54);
	
    var state = {
      selectedFacets: {}
    }
	
	window.onhashchange = toggleFacets;
	
	function toggleFacets(){
		var operation = location.hash;
	
		if(operation=="#search" || operation=="#getentities" || operation=="#getrelatedentities" || operation=="#getentitiesbyattribute") {
			document.getElementById('inputFacets').style.display='block';
			document.getElementById('outputFacets').style.display='block';
		}
		else if(operation=="#autocomplete") {
			document.getElementById('inputFacets').style.display='none';
			document.getElementById('outputFacets').style.display='none';
		}
	}
	
    function callLoop54(selectedFacets) {
	
		if(!selectedFacets)
			selectedFacets = {};
	
		var options = {};
		
		options.skip = document.getElementById('form').elements['skip'].value;
		options.take = document.getElementById('form').elements['take'].value;
		
		var distinctFacets = document.getElementById('form').elements['distinctFacets'].value.split(',').map(function(f){return {name:f,attributeName:f,type:'distinct',selected:selectedFacets[f]}});
		var rangeFacets = document.getElementById('form').elements['rangeFacets'].value.split(',').map(function(f){return {name:f,attributeName:f,type:'range',selected:selectedFacets[f]}});
		
		options.facets = [...distinctFacets,...rangeFacets];
	
		var operation = location.hash;
	
		if(operation=="#search") {
			Loop54.search(document.getElementById('form').elements['query'].value, options, printResponse);
		}
		else if(operation=="#autocomplete")
		{
			delete options.facets;
			Loop54.autoComplete(document.getElementById('form').elements['query'].value, options, printResponse);
		}
		else if(operation=="#getentities")
		{
			Loop54.getEntities(options, printResponse);
		}
		else if(operation=="#getentitiesbyattribute")
		{
			var nameValuePair = document.getElementById('form').elements['query'].value.split(':');
			Loop54.getEntitiesByAttribute(nameValuePair[0],nameValuePair[1],options, printResponse);
		}
		else if(operation=="#getrelatedentities")
		{
			var typeIdPair = document.getElementById('form').elements['query'].value.split(':');
			Loop54.getRelatedEntities({type:typeIdPair[0],id:typeIdPair[1]}, options, printResponse);
		}
		else {
			console.log("unknown operation " + operation);
		}
		
		return false;
    }

    function updateFacets() {
	
		var facetsFormElements = document.getElementById('facetsForm').elements;
		var selectedFacets = state.selectedFacets ? state.selectedFacets : {};
		
		for(var i=0; i<facetsFormElements.length; i++) {
			var facet = facetsFormElements[i];
			
			if(!selectedFacets[facet.name]) { 
				selectedFacets[facet.name] = [] ;
			}
			
			if(facet.checked) {
				var index = selectedFacets[facet.name].indexOf(facet.value);
				if (index == -1) {
					selectedFacets[facet.name].push(facet.value);
				}
			}
			else {
				var arr = selectedFacets[facet.name];
				
				var index = arr.indexOf(facet.value);
				if (index > -1) {
					arr.splice(index, 1);
				}
				
				if(arr.length==0) {
					delete selectedFacets[facet.name];
				}
			}
		}

		state.selectedFacets = selectedFacets;

		callLoop54(selectedFacets);
		return false;
    }

    function doRangeFaceting(range, name) {
		var selectedFacets = state.selectedFacets ? state.selectedFacets : {};
		selectedFacets[name] = {min: range[0], max: range[1]};

		state.selectedFacets = selectedFacets;
		callLoop54(selectedFacets);
    }

    function printResponse(response) {
		console.log('response', response);
		document.getElementById('resultCount').innerText = response.data.results ? response.data.results.count : response.data.queries.count;
		var str = JSON.stringify(response, null, 2);
		document.getElementById('searchResult').innerText = str;
		var facetsForm = document.getElementById('facetsForm');
		facetsForm.innerHTML = '';
		
		if(response.data.results && response.data.results.facets.length > 0) {
			renderFacets(response.data.results.facets);
		}
    }
	
	function renderFacets(facets) {
		for(var i=0;i<facets.length; i++) {
			var facet = facets[i];
			var title = document.createElement('h3');
			title.innerText = facet.name;
			facetsForm.appendChild(title);
			var list = document.createElement('div');
			if(facet.type == 'distinct') {
				for(var y=0; y<facet.items.length; y++) {
					var listItem = document.createElement('div');
					var isChecked = null;
					if(state.selectedFacets[facet.name]) {
						if(state.selectedFacets[facet.name].includes(facet.items[y].item)) {
							isChecked = 'checked';
						}
					}
					listItem.innerHTML = '<input type="checkbox" id="'+facet.name+'-'+y+'" name="'+facet.name+'" value="'+facet.items[y].item+'" '+isChecked+' /><label for="facets-'+y+'">'+facet.items[y].item+' ('+facet.items[y].count+')</label>';
					list.appendChild(listItem);
					facetsForm.appendChild(list);
				}
			} 
			else if(facet.type == 'range') {
				var listItem = document.createElement('div');
				listItem.id = facet.name;
				listItem.className = 'range-slider range-slider-' + i;
				list.appendChild(listItem);
				facetsForm.appendChild(list);

				var selectedFacet = state.selectedFacets[facet.name];
				var min = selectedFacet ? selectedFacet.min : facet.min;
				var max = selectedFacet ? selectedFacet.max : facet.max;

				noUiSlider.create(listItem, {
					connect: true,
					behaviour: 'tap',
					start: [ min, max],
					tooltips: true,
					range: {
						// Starting at 500, step the value by 500,
						// until 4000 is reached. From there, step by 1000.
						'min': [ facet.min ],
						'max': [ facet.max ]
					}
				});

				listItem.noUiSlider.on('change', function(data) {
					doRangeFaceting(data, listItem.id);
				});
			}
        }
	}
  </script>
</body>
</html>
